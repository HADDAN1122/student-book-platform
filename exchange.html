<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="responsive.css">
    <title>Book Exchange | Student Platform</title>
    <style>
        /* Exchange Specific Styles */
        .exchange-hero {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 60px 20px;
            text-align: center;
            border-radius: 0 0 20px 20px;
            margin-bottom: 40px;
        }
        
        .exchange-hero h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .exchange-hero p {
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto 30px;
            opacity: 0.9;
        }
        
        .exchange-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 30px;
        }
        
        .exchange-stat {
            text-align: center;
        }
        
        .stat-number {
            display: block;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .exchange-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .exchange-main {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .exchange-sidebar {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .section-title {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            font-size: 1.5rem;
        }
        
        .exchange-pair {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .exchange-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px dashed #ddd;
            transition: all 0.3s ease;
        }
        
        .exchange-box:hover {
            border-color: #6a11cb;
            background: #f5f0ff;
        }
        
        .exchange-box h3 {
            margin-bottom: 15px;
            color: #555;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #444;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #6a11cb;
            box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.1);
        }
        
        .contact-options {
            margin-top: 20px;
        }
        
        .contact-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .contact-option input {
            width: auto;
            margin: 0;
        }
        
        .submit-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.3);
        }
        
        .wishlist-btn {
            background: #28a745;
        }
        
        .matches-section {
            margin-top: 30px;
        }
        
        .match-card {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .match-card h4 {
            color: #2e7d32;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .match-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            text-align: center;
        }
        
        .exchange-arrow {
            font-size: 2rem;
            color: #6a11cb;
        }
        
        .contact-action {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .contact-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: opacity 0.3s ease;
        }
        
        .email-btn {
            background: #4285f4;
            color: white;
        }
        
        .whatsapp-btn {
            background: #25D366;
            color: white;
        }
        
        .wishlist-section h3 {
            color: #6a11cb;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .wishlist-items {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .wishlist-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #6a11cb;
        }
        
        .wishlist-item h4 {
            margin-bottom: 5px;
            color: #333;
        }
        
        .wishlist-item p {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 10px;
        }
        
        .recent-exchanges {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #eee;
        }
        
        .exchange-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .exchange-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border: 1px solid #eee;
        }
        
        .exchange-card h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .exchange-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        
        .have-section, .want-section {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .badge {
            background: #6a11cb;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }
        
        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .exchange-container {
                grid-template-columns: 1fr;
            }
            
            .exchange-pair {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .exchange-grid {
                grid-template-columns: 1fr;
            }
            
            .match-comparison {
                grid-template-columns: 1fr;
                text-align: left;
            }
            
            .exchange-arrow {
                transform: rotate(90deg);
                text-align: center;
                margin: 10px 0;
            }
        }

        @media (max-width: 768px) {
    .exchange-container {
        grid-template-columns: 1fr !important;
        padding: 10px !important;
    }
    
    .match-comparison {
        grid-template-columns: 1fr !important;
        text-align: center;
    }
    
    .exchange-arrow {
        transform: rotate(90deg);
        margin: 15px 0;
        font-size: 2rem;
    }
}
    </style>
</head>
<body>
    <header>
        <h1>Student Platform</h1>
        <nav>
            <a href="index.html">Home</a>
            <a href="search.html">Search</a>
            <a href="login.html" class="login-circle">Login</a>
        </nav>
        <hr>
    </header>

    <main>
        <!-- Hero Section -->
        <section class="exchange-hero">
            <h1>üìö Exchange Platform</h1>
            <p>Trade your books with fellow students. Find perfect matches based on subject, class, and location.</p>
            <div class="exchange-stats">
                <div class="exchange-stat">
                    <span class="stat-number">500+</span>
                    <span class="stat-label">Active Exchanges</span>
                </div>
                <div class="exchange-stat">
                    <span class="stat-number">89%</span>
                    <span class="stat-label">Success Rate</span>
                </div>
                <div class="exchange-stat">
                    <span class="stat-number">50+</span>
                    <span class="stat-label">Schools Participating</span>
                </div>
            </div>
        </section>

        <div class="exchange-container">
            <!-- Main Content -->
            <div class="exchange-main">
                <!-- Exchange Form -->
                <form id="exchangeForm">
                    <div class="form-section">
                        <h2 class="section-title">üìã Exchange Details</h2>
                        
                        <div class="exchange-pair">
                            <div class="exchange-box">
                                <h3>üìö I HAVE (Book to Trade)</h3>
                                <div class="form-group">
                                    <label for="haveBook">Book Title *</label>
                                    <input type="text" id="haveBook" placeholder="e.g., Physics Textbook Class 10" required>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="haveSubject">Subject *</label>
                                        <select id="haveSubject" required>
                                            <option value="">Select Subject</option>
                                            <option>Mathematics</option>
                                            <option>Physics</option>
                                            <option>Chemistry</option>
                                            <option>Biology</option>
                                            <option>English</option>
                                            <option>Computer Science</option>
                                            <option>Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="haveClass">Class/Grade *</label>
                                        <select id="haveClass" required>
                                            <option value="">Select Class</option>
                                            <option>All Classes</option>
                                            <option>9th Grade</option>
                                            <option>10th Grade</option>
                                            <option>11th Grade</option>
                                            <option>12th Grade</option>
                                            <option>University</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="haveCondition">Condition *</label>
                                    <select id="haveCondition" required>
                                        <option value="">Select Condition</option>
                                        <option>Like New</option>
                                        <option>Very Good</option>
                                        <option>Good</option>
                                        <option>Fair</option>
                                        <option>Poor</option>
                                    </select>
                                </div>
                            </div>

                            <div class="exchange-box">
                                <h3>üéØ I WANT (Desired Book)</h3>
                                <div class="form-group">
                                    <label for="wantBook">Book Title *</label>
                                    <input type="text" id="wantBook" placeholder="e.g., Chemistry Textbook Class 10" required>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="wantSubject">Subject *</label>
                                        <select id="wantSubject" required>
                                            <option value="">Select Subject</option>
                                            <option>Mathematics</option>
                                            <option>Physics</option>
                                            <option>Chemistry</option>
                                            <option>Biology</option>
                                            <option>English</option>
                                            <option>Computer Science</option>
                                            <option>Any</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="wantClass">Class/Grade *</label>
                                        <select id="wantClass" required>
                                            <option value="">Select Class</option>
                                            <option>All Classes</option>
                                            <option>9th Grade</option>
                                            <option>10th Grade</option>
                                            <option>11th Grade</option>
                                            <option>12th Grade</option>
                                            <option>University</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="wantCondition">Acceptable Condition</label>
                                    <select id="wantCondition">
                                        <option value="Any">Any Condition</option>
                                        <option>Like New</option>
                                        <option>Very Good</option>
                                        <option>Good or Better</option>
                                        <option>Fair or Better</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="schoolName">Your School/College</label>
                                <input type="text" id="schoolName" placeholder="e.g., City Public School">
                            </div>
                            <div class="form-group">
                                <label for="location">Your City *</label>
                                <input type="text" id="location" placeholder="e.g., New York" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="exchangeMethod">Preferred Exchange Method *</label>
                            <select id="exchangeMethod" required>
                                <option value="">Select Method</option>
                                <option value="in-person">In-person Meetup</option>
                                <option value="shipping">Shipping by Mail</option>
                                <option value="both">Both Options</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="additionalNotes">Additional Notes</label>
                            <textarea id="additionalNotes" placeholder="Any special requirements or details about the exchange..." rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <div class="form-section">
                        <h2 class="section-title">üìû Contact Information</h2>
                        <p style="color: #666; margin-bottom: 15px;">Choose how other users can contact you for exchange:</p>
                        
                        <div class="contact-options">
                            <div class="contact-option">
                                <input type="checkbox" id="shareEmail" checked>
                                <label for="shareEmail">Share my email for exchange inquiries</label>
                            </div>
                            <div class="contact-option">
                                <input type="checkbox" id="shareWhatsApp">
                                <label for="shareWhatsApp">Share WhatsApp number (for direct messaging)</label>
                            </div>
                        </div>

                        <div class="form-group" id="emailField">
                            <label for="email">Email Address *</label>
                            <input type="email" id="email" placeholder="your.email@example.com" required>
                        </div>

                        <div class="form-group" id="whatsappField" style="display: none;">
                            <label for="whatsapp">WhatsApp Number</label>
                            <input type="tel" id="whatsapp" placeholder="+1234567890">
                        </div>
                    </div>

                    <!-- Submit Section -->
                    <div class="form-submit-section">
                        <div class="submit-buttons">
                            <button type="submit" class="submit-btn">Post Exchange Offer</button>
                            <button type="button" class="submit-btn wishlist-btn" id="addToWishlist">Add to Wishlist</button>
                        </div>
                        <div id="exchangeError" class="error-message"></div>
                        <div id="exchangeSuccess" class="success-message"></div>
                    </div>
                </form>

                <!-- Matches Section -->
                <div class="matches-section" id="matchesSection">
                    <h2 class="section-title">üéØ Your Matches</h2>
                    <div id="matchesList">
                        <!-- Matches will be dynamically loaded here -->
                    </div>
                </div>

                <!-- Recent Exchanges -->
                <div class="recent-exchanges">
                    <h2 class="section-title">üîÑ Recent Exchange Offers</h2>
                    <div class="exchange-grid" id="exchangeGrid">
                        <!-- Recent exchanges will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="exchange-sidebar">
                <!-- Wishlist -->
                <div class="wishlist-section">
                    <h3 class="section-title">‚≠ê My Wishlist</h3>
                    <div class="wishlist-items" id="wishlistItems">
                        <!-- Wishlist items will be loaded here -->
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="stats-section" style="margin-top: 30px;">
                    <h3 class="section-title">üìä Exchange Stats</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <p style="margin: 10px 0;">Your Active Offers: <strong id="activeOffers">0</strong></p>
                        <p style="margin: 10px 0;">Wishlist Items: <strong id="wishlistCount">0</strong></p>
                        <p style="margin: 10px 0;">Successful Exchanges: <strong id="successfulExchanges">0</strong></p>
                    </div>
                </div>

                <!-- Tips -->
                <div class="tips-section" style="margin-top: 30px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üí° Exchange Tips</h4>
                    <ul style="font-size: 0.9rem; color: #856404; padding-left: 20px;">
                        <li>Be clear about book condition</li>
                        <li>Meet in public places for safety</li>
                        <li>Check books before exchanging</li>
                        <li>Update your listing after exchange</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- Your Firebase Config -->
    <script src="firebase.js"></script>

    <!-- Your Auth Functions -->
    <script src="auth.js"></script>

    <script>
        // Main Exchange Application
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const exchangeForm = document.getElementById('exchangeForm');
            const addToWishlistBtn = document.getElementById('addToWishlist');
            const shareEmailCheckbox = document.getElementById('shareEmail');
            const shareWhatsAppCheckbox = document.getElementById('shareWhatsApp');
            const emailField = document.getElementById('emailField');
            const whatsappField = document.getElementById('whatsappField');
            const exchangeError = document.getElementById('exchangeError');
            const exchangeSuccess = document.getElementById('exchangeSuccess');
            const matchesList = document.getElementById('matchesList');
            const exchangeGrid = document.getElementById('exchangeGrid');
            const wishlistItems = document.getElementById('wishlistItems');
            const activeOffers = document.getElementById('activeOffers');
            const wishlistCount = document.getElementById('wishlistCount');
            const successfulExchanges = document.getElementById('successfulExchanges');

            // Firebase References
            let db, auth, currentUser;
            
            // Initialize Firebase
            if (typeof firebase !== 'undefined') {
                db = firebase.firestore();
                auth = firebase.auth();
                
                // Check authentication
                auth.onAuthStateChanged((user) => {
                    currentUser = user;
                    if (user) {
                        loadUserData(user.uid);
                        loadExchangeOffers();
                        loadMatches(user.uid);
                    } else {
                        // Redirect to login if not authenticated
                        window.location.href = 'login.html?redirect=exchange.html';
                    }
                });
            }

            // Toggle WhatsApp field
            shareWhatsAppCheckbox.addEventListener('change', function() {
                whatsappField.style.display = this.checked ? 'block' : 'none';
            });

            // Post Exchange Offer
            exchangeForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                clearMessages();

                if (!currentUser) {
                    showError('Please login to post exchange offers');
                    return;
                }

                // Validate form
                const errors = validateExchangeForm();
                if (errors.length > 0) {
                    showError(errors.join('<br>'));
                    return;
                }

                try {
                    // Create exchange offer object
                    const exchangeData = {
                        userId: currentUser.uid,
                        userEmail: currentUser.email,
                        haveBook: {
                            title: document.getElementById('haveBook').value.trim(),
                            subject: document.getElementById('haveSubject').value,
                            class: document.getElementById('haveClass').value,
                            condition: document.getElementById('haveCondition').value
                        },
                        wantBook: {
                            title: document.getElementById('wantBook').value.trim(),
                            subject: document.getElementById('wantSubject').value,
                            class: document.getElementById('wantClass').value,
                            condition: document.getElementById('wantCondition').value
                        },
                        school: document.getElementById('schoolName').value.trim(),
                        location: document.getElementById('location').value.trim(),
                        exchangeMethod: document.getElementById('exchangeMethod').value,
                        notes: document.getElementById('additionalNotes').value.trim(),
                        contact: {
                            email: shareEmailCheckbox.checked ? document.getElementById('email').value.trim() : null,
                            whatsapp: shareWhatsAppCheckbox.checked ? document.getElementById('whatsapp').value.trim() : null
                        },
                        status: 'active',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    // Save to Firestore
                    await db.collection('exchangeOffers').add(exchangeData);

                    // Show success message
                    showSuccess('‚úÖ Exchange offer posted successfully! Others can now see your offer.');

                    // Reset form
                    exchangeForm.reset();
                    whatsappField.style.display = 'none';

                    // Reload data
                    loadUserData(currentUser.uid);
                    loadExchangeOffers();
                    loadMatches(currentUser.uid);

                } catch (error) {
                    console.error('Error posting exchange:', error);
                    showError('Failed to post exchange offer. Please try again.');
                }
            });

            // Add to Wishlist
            addToWishlistBtn.addEventListener('click', async function() {
                if (!currentUser) {
                    showError('Please login to add to wishlist');
                    return;
                }

                const wantBookTitle = document.getElementById('wantBook').value.trim();
                const wantSubject = document.getElementById('wantSubject').value;
                const wantClass = document.getElementById('wantClass').value;

                if (!wantBookTitle || !wantSubject || !wantClass) {
                    showError('Please fill in the "I WANT" section to add to wishlist');
                    return;
                }

                try {
                    const wishlistItem = {
                        userId: currentUser.uid,
                        bookTitle: wantBookTitle,
                        subject: wantSubject,
                        class: wantClass,
                        condition: document.getElementById('wantCondition').value,
                        notes: document.getElementById('additionalNotes').value.trim(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await db.collection('wishlist').add(wishlistItem);
                    showSuccess('‚úÖ Added to your wishlist! We\'ll notify you when a match is found.');
                    loadUserData(currentUser.uid);

                } catch (error) {
                    console.error('Error adding to wishlist:', error);
                    showError('Failed to add to wishlist. Please try again.');
                }
            });

            // Form Validation
            function validateExchangeForm() {
                const errors = [];
                const haveBook = document.getElementById('haveBook').value.trim();
                const wantBook = document.getElementById('wantBook').value.trim();
                const email = document.getElementById('email').value.trim();

                if (!haveBook) errors.push('Please enter the book you have');
                if (!wantBook) errors.push('Please enter the book you want');
                if (shareEmailCheckbox.checked && !email) errors.push('Email is required when sharing contact');
                if (shareEmailCheckbox.checked && !isValidEmail(email)) errors.push('Please enter a valid email address');
                if (shareWhatsAppCheckbox.checked && !document.getElementById('whatsapp').value.trim()) {
                    errors.push('WhatsApp number is required when selected');
                }

                return errors;
            }

            // Helper Functions
            function isValidEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }

            function showError(message) {
                exchangeError.innerHTML = message;
                exchangeError.style.display = 'block';
            }

            function showSuccess(message) {
                exchangeSuccess.innerHTML = message;
                exchangeSuccess.style.display = 'block';
                setTimeout(() => {
                    exchangeSuccess.style.display = 'none';
                }, 5000);
            }

            function clearMessages() {
                exchangeError.style.display = 'none';
                exchangeSuccess.style.display = 'none';
            }

            // Load User Data
            async function loadUserData(userId) {
                try {
                    // Load wishlist
                    const wishlistSnapshot = await db.collection('wishlist')
                        .where('userId', '==', userId)
                        .orderBy('createdAt', 'desc')
                        .get();

                    wishlistItems.innerHTML = '';
                    wishlistCount.textContent = wishlistSnapshot.size;

                    if (wishlistSnapshot.empty) {
                        wishlistItems.innerHTML = '<p style="color: #666; text-align: center;">No wishlist items yet</p>';
                    } else {
                        wishlistSnapshot.forEach(doc => {
                            const item = doc.data();
                            const wishlistItem = document.createElement('div');
                            wishlistItem.className = 'wishlist-item';
                            wishlistItem.innerHTML = `
                                <h4>${item.bookTitle}</h4>
                                <p>Subject: ${item.subject} ‚Ä¢ Class: ${item.class}</p>
                                <p>Condition: ${item.condition}</p>
                                ${item.notes ? `<p><small>${item.notes}</small></p>` : ''}
                                <button class="remove-btn" onclick="removeWishlistItem('${doc.id}')">Remove</button>
                            `;
                            wishlistItems.appendChild(wishlistItem);
                        });
                    }

                    // Load active offers count
                    const offersSnapshot = await db.collection('exchangeOffers')
                        .where('userId', '==', userId)
                        .where('status', '==', 'active')
                        .get();

                    activeOffers.textContent = offersSnapshot.size;

                    // Load successful exchanges count
                    const successSnapshot = await db.collection('exchangeHistory')
                        .where('userId', '==', userId)
                        .where('status', '==', 'completed')
                        .get();

                    successfulExchanges.textContent = successSnapshot.size;

                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            }

            // Load Exchange Offers
            async function loadExchangeOffers() {
                try {
                    const snapshot = await db.collection('exchangeOffers')
                        .where('status', '==', 'active')
                        .orderBy('createdAt', 'desc')
                        .limit(6)
                        .get();

                    exchangeGrid.innerHTML = '';

                    if (snapshot.empty) {
                        exchangeGrid.innerHTML = '<p style="color: #666; text-align: center;">No exchange offers available yet</p>';
                    } else {
                        snapshot.forEach(doc => {
                            const offer = doc.data();
                            if (offer.userId === currentUser?.uid) return; // Skip own offers

                            const exchangeCard = document.createElement('div');
                            exchangeCard.className = 'exchange-card';
                            exchangeCard.innerHTML = `
                                <span class="badge">Available for Exchange</span>
                                <h4>${offer.haveBook.title}</h4>
                                <div class="exchange-details">
                                    <div class="have-section">
                                        <h5>üìö HAS:</h5>
                                        <p>${offer.haveBook.title}</p>
                                        <small>${offer.haveBook.subject} ‚Ä¢ Class ${offer.haveBook.class}</small>
                                        <small>Condition: ${offer.haveBook.condition}</small>
                                    </div>
                                    <div class="want-section">
                                        <h5>üéØ WANTS:</h5>
                                        <p>${offer.wantBook.title}</p>
                                        <small>${offer.wantBook.subject} ‚Ä¢ Class ${offer.wantBook.class}</small>
                                    </div>
                                </div>
                                <div style="margin-top: 10px;">
                                    <small>üìç ${offer.location} ‚Ä¢ ${offer.exchangeMethod === 'in-person' ? 'üìç In-person' : 'üì¶ Shipping'}</small>
                                </div>
                                <div class="contact-action">
                                    ${offer.contact.email ? 
                                        `<button class="contact-btn email-btn" onclick="contactViaEmail('${offer.userEmail}', '${offer.haveBook.title}', '${offer.wantBook.title}')">
                                            ‚úâÔ∏è Email
                                        </button>` : ''}
                                    ${offer.contact.whatsapp ? 
                                        `<button class="contact-btn whatsapp-btn" onclick="contactViaWhatsApp('${offer.contact.whatsapp}', '${offer.haveBook.title}')">
                                            üí¨ WhatsApp
                                        </button>` : ''}
                                </div>
                            `;
                            exchangeGrid.appendChild(exchangeCard);
                        });
                    }
                } catch (error) {
                    console.error('Error loading exchange offers:', error);
                }
            }

            // Load Matches
            async function loadMatches(userId) {
                try {
                    // Get user's exchange offers
                    const userOffersSnapshot = await db.collection('exchangeOffers')
                        .where('userId', '==', userId)
                        .where('status', '==', 'active')
                        .get();

                    matchesList.innerHTML = '';

                    if (userOffersSnapshot.empty) {
                        matchesList.innerHTML = '<p style="color: #666; text-align: center;">No matches found yet. Post an exchange offer!</p>';
                        return;
                    }

                    // For each user offer, find matches
                    for (const userDoc of userOffersSnapshot.docs) {
                        const userOffer = userDoc.data();

                        // Find offers where someone has what user wants
                        const matchesSnapshot = await db.collection('exchangeOffers')
                            .where('haveBook.title', '==', userOffer.wantBook.title)
                            .where('wantBook.title', '==', userOffer.haveBook.title)
                            .where('status', '==', 'active')
                            .where('userId', '!=', userId)
                            .limit(3)
                            .get();

                        if (!matchesSnapshot.empty) {
                            matchesSnapshot.forEach(matchDoc => {
                                const match = matchDoc.data();
                                const matchCard = document.createElement('div');
                                matchCard.className = 'match-card';
                                matchCard.innerHTML = `
                                    <h4>üéØ Perfect Match Found!</h4>
                                    <div class="match-comparison">
                                        <div class="user-offer">
                                            <h5>Your Book:</h5>
                                            <p>${userOffer.haveBook.title}</p>
                                            <small>${userOffer.haveBook.subject} ‚Ä¢ ${userOffer.haveBook.condition}</small>
                                        </div>
                                        <div class="exchange-arrow">‚áÑ</div>
                                        <div class="matched-offer">
                                            <h5>Their Book:</h5>
                                            <p>${match.haveBook.title}</p>
                                            <small>${match.haveBook.subject} ‚Ä¢ ${match.location}</small>
                                        </div>
                                    </div>
                                    <div class="contact-action">
                                        ${match.contact.email ? 
                                            `<button class="contact-btn email-btn" onclick="contactViaEmail('${match.userEmail}', '${userOffer.haveBook.title}', '${match.haveBook.title}')">
                                                ‚úâÔ∏è Email for Exchange
                                            </button>` : ''}
                                        ${match.contact.whatsapp ? 
                                            `<button class="contact-btn whatsapp-btn" onclick="contactViaWhatsApp('${match.contact.whatsapp}', '${userOffer.haveBook.title}')">
                                                üí¨ WhatsApp
                                            </button>` : ''}
                                    </div>
                                `;
                                matchesList.appendChild(matchCard);
                            });
                        }
                    }

                    if (matchesList.innerHTML === '') {
                        matchesList.innerHTML = '<p style="color: #666; text-align: center;">No matches found yet. Check back later!</p>';
                    }

                } catch (error) {
                    console.error('Error loading matches:', error);
                }
            }

            // Global functions for contact buttons
            window.contactViaEmail = function(email, haveBook, wantBook) {
                const subject = `Book Exchange: ${haveBook} for ${wantBook}`;
                const body = `Hello,\n\nI saw your exchange offer for "${haveBook}". I have "${wantBook}" and would like to exchange.\n\nPlease let me know if you're interested!\n\nBest regards,\n[Your Name]`;
                window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            };

            window.contactViaWhatsApp = function(phoneNumber, bookTitle) {
                const message = `Hello! I'm interested in your exchange offer for "${bookTitle}". Are you still looking to exchange?`;
                const whatsappUrl = `https://wa.me/${phoneNumber.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            };

            window.removeWishlistItem = async function(itemId) {
                if (!confirm('Remove this item from wishlist?')) return;
                
                try {
                    await db.collection('wishlist').doc(itemId).delete();
                    if (currentUser) {
                        loadUserData(currentUser.uid);
                    }
                } catch (error) {
                    console.error('Error removing wishlist item:', error);
                    alert('Failed to remove item. Please try again.');
                }
            };
        });
    </script>

    <script>
        // Header scroll effect
        window.addEventListener('scroll', function() {
            const header = document.querySelector('header');
            if (window.scrollY > 50) {
                header.classList.add('shrink');
            } else {
                header.classList.remove('shrink');
            }
        });
    </script>

    <script>// Header shrink on scroll for mobile
let lastScrollTop = 0;
const header = document.querySelector('header');
const shrinkThreshold = 50; // Pixels to scroll before shrinking

window.addEventListener('scroll', function() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    
    if (window.innerWidth <= 768) { // Mobile only
        if (scrollTop > shrinkThreshold) {
            header.classList.add('shrink');
        } else {
            header.classList.remove('shrink');
        }
        
        // Optional: Hide header on scroll down, show on scroll up
        if (scrollTop > lastScrollTop && scrollTop > 100) {
            // Scrolling down
            header.style.transform = 'translateY(-100%)';
        } else {
            // Scrolling up
            header.style.transform = 'translateY(0)';
        }
        
        lastScrollTop = scrollTop;
    } else {
        // Desktop behavior (keep your existing desktop shrink logic)
        if (scrollTop > shrinkThreshold) {
            header.classList.add('shrink');
        } else {
            header.classList.remove('shrink');
        }
    }
});

// Optional: Add parallax-like effect for mobile
window.addEventListener('scroll', function() {
    if (window.innerWidth <= 768) {
        const scrolled = window.pageYOffset;
        const rate = scrolled * -0.3; // Adjust this value for intensity
        
        // Add subtle background color change on scroll
        if (header && scrolled > 20) {
            const opacity = Math.min(scrolled / 200, 0.95);
            header.style.backgroundColor = `rgba(255, 255, 255, ${opacity})`;
            header.style.backdropFilter = 'blur(10px)';
        } else if (header) {
            header.style.backgroundColor = 'white';
            header.style.backdropFilter = 'none';
        }
    }
});</script>
</body>
</html>