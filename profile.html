<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="responsive.css">
    <title>My Profile | Student Platform</title>
    <style>
        /* Additional Profile Styles */
        .profile-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
        }
        
        .profile-header-section {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #8a56ff 0%, #64ffda 100%);
            border-radius: 20px;
            color: white;
        }
        
        .emoji-display-large {
            font-size: 5rem;
            background: white;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .user-basic-info h1 {
            margin: 0 0 10px 0;
            font-size: 2.2rem;
        }
        
        .user-basic-info .email {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .user-meta {
            display: flex;
            gap: 20px;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 768px) {
            .profile-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .profile-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 1px solid #eee;
        }
        
        .profile-card h2 {
            margin: 0 0 25px 0;
            color: #333;
            font-size: 1.5rem;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .info-grid {
            display: grid;
            gap: 20px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .info-item:hover {
            background: #f0f0ff;
            transform: translateX(5px);
        }
        
        .info-label {
            font-weight: 600;
            color: #555;
        }
        
        .info-value {
            font-weight: 600;
            color: #8a56ff;
        }
        
        .edit-btn {
            background: #8a56ff;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .edit-btn:hover {
            background: #7a46ef;
            transform: translateY(-2px);
        }
        
        .profile-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
        }
        
        .action-btn {
            padding: 15px 25px;
            background: white;
            border: 2px solid #8a56ff;
            color: #8a56ff;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 200px;
            justify-content: center;
        }
        
        .action-btn:hover {
            background: #8a56ff;
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(138, 86, 255, 0.3);
        }
        
        .action-btn.logout {
            border-color: #ff4444;
            color: #ff4444;
        }
        
        .action-btn.logout:hover {
            background: #ff4444;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, #f5f5ff 0%, #f0f5ff 100%);
            border-radius: 15px;
            border: 1px solid #eee;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #8a56ff;
            display: block;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .emoji-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .current-emoji-display {
            font-size: 3rem;
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .emoji-info {
            flex: 1;
        }
        
        .emoji-number-badge {
            display: inline-block;
            background: #8a56ff;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 30px;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            flex: 1;
        }
        
        .btn-primary {
            background: #8a56ff;
            color: white;
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .btn-primary:hover {
            background: #7a46ef;
        }
        
        .btn-secondary:hover {
            background: #e5e5e5;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #8a56ff;
            font-size: 1.2rem;
        }
        
        .error-message {
            background: #ffebee;
            color: #ff4444;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        
        .success-message {
            background: #e8f5e9;
            color: #4caf50;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        
        /* Activity Timeline */
        .activity-timeline {
            margin-top: 20px;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-left: 3px solid #8a56ff;
            margin-bottom: 15px;
            background: #f9f9f9;
            border-radius: 0 10px 10px 0;
        }
        
        .activity-icon {
            font-size: 1.5rem;
            color: #8a56ff;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-time {
            font-size: 0.8rem;
            color: #888;
        }
        
        /* User Menu Styles */
        .user-menu-container {
            position: relative;
            display: inline-block;
        }
        
        .user-emoji-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8a56ff 0%, #64ffda 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .user-emoji-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(138, 86, 255, 0.3);
        }
        
        .user-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 50px;
            background: white;
            min-width: 250px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow: hidden;
            border: 1px solid #eee;
        }
        
        .user-dropdown.active {
            display: block;
            animation: dropdownFade 0.2s ease;
        }
        
        @keyframes dropdownFade {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .dropdown-header {
            padding: 20px;
            background: linear-gradient(135deg, #8a56ff 0%, #64ffda 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .dropdown-emoji {
            font-size: 2.5rem;
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dropdown-user-info {
            flex: 1;
        }
        
        .dropdown-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .dropdown-email {
            font-size: 0.9rem;
            opacity: 0.9;
            word-break: break-all;
        }
        
        .dropdown-divider {
            height: 1px;
            background: #eee;
            margin: 5px 0;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            text-decoration: none;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 1rem;
        }
        
        .dropdown-item:hover {
            background: #f5f5ff;
            color: #8a56ff;
        }
        
        .dropdown-item.logout:hover {
            background: #ffebee;
            color: #ff4444;
        }
        
        .dropdown-item span {
            font-size: 1.2rem;
            width: 20px;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #8a56ff;
            box-shadow: 0 0 0 3px rgba(138, 86, 255, 0.1);
        }
    </style>
</head>
<body>
    <header>
        <h1>Student Platform</h1>
        <nav>
            <a href="index.html">Home</a>
            <a href="sell.html">Sell & Buy</a>
            <a href="exchange.html">Exchange Book</a>
            <a href="search.html">üîç Search</a>
            
            <!-- User Emoji Menu -->
            <div class="user-menu-container">
                <div id="userEmojiBtn" class="user-emoji-btn">
                    üë§ <!-- Default emoji, will be replaced by JS -->
                </div>
                <div id="userDropdown" class="user-dropdown">
                    <div class="dropdown-header">
                        <div id="dropdownEmoji" class="dropdown-emoji">üë§</div>
                        <div class="dropdown-user-info">
                            <div id="dropdownName" class="dropdown-name">User</div>
                            <div id="dropdownEmail" class="dropdown-email">user@example.com</div>
                        </div>
                    </div>
                    <div class="dropdown-divider"></div>
                    <a href="profile.html" class="dropdown-item">
                        <span>üë§</span> My Profile
                    </a>
                    <a href="mylistings.html" class="dropdown-item">
                        <span>üìö</span> My Listings
                    </a>
                    <div class="dropdown-divider"></div>
                    <button onclick="logoutUser()" class="dropdown-item logout">
                        <span>üö™</span> Logout
                    </button>
                </div>
            </div>
        </nav>
        <hr>
    </header>

    <main>
        <div class="profile-container">
            <!-- Profile Header -->
            <div class="profile-header-section">
                <div id="profileEmoji" class="emoji-display-large"></div>
                <div class="user-basic-info">
                    <h1 id="profileName">Loading...</h1>
                    <div class="email" id="profileEmail">Loading...</div>
                    <div class="user-meta">
                        <div class="meta-item">
                            <span>üë§</span>
                            <span id="userType">Student</span>
                        </div>
                        <div class="meta-item">
                            <span>üìÖ</span>
                            <span id="memberSince">Member since: Loading...</span>
                        </div>
                        <div class="meta-item">
                            <span>‚≠ê</span>
                            <span id="userRating">Rating: Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Profile Grid -->
            <div class="profile-grid">
                <!-- Personal Information -->
                <div class="profile-card">
                    <h2>Personal Information</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Full Name</span>
                            <span class="info-value" id="fullName">Not set</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Phone Number</span>
                            <span class="info-value" id="phoneNumber">Not set</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">University/College</span>
                            <span class="info-value" id="university">Not set</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Study Program</span>
                            <span class="info-value" id="studyProgram">Not set</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Current Year</span>
                            <span class="info-value" id="currentYear">Not set</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Location</span>
                            <span class="info-value" id="location">Not set</span>
                        </div>
                    </div>
                    <button onclick="openEditModal()" class="edit-btn">‚úèÔ∏è Edit Profile</button>
                </div>
                
                <!-- Account Statistics -->
                <div class="profile-card">
                    <h2>Account Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number" id="booksListed">0</span>
                            <span class="stat-label">Books Listed</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="booksSold">0</span>
                            <span class="stat-label">Books Sold</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="booksBought">0</span>
                            <span class="stat-label">Books Bought</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="exchangesMade">0</span>
                            <span class="stat-label">Exchanges Made</span>
                        </div>
                    </div>
                    
                    <div class="emoji-controls">
                        <div class="current-emoji-display" id="currentEmojiDisplay">üë®</div>
                        <div class="emoji-info">
                            <h3>Your Avatar</h3>
                            <p>Your current emoji: <span id="emojiText">üë®</span> 
                                <span class="emoji-number-badge" id="emojiNumber">0</span>
                            </p>
                            <p><small>Assigned based on your email</small></p>
                        </div>
                        <button onclick="changeEmoji()" class="action-btn">üîÑ Change</button>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="profile-card">
                    <h2>Recent Activity</h2>
                    <div class="activity-timeline" id="activityTimeline">
                        <div class="loading">Loading activities...</div>
                    </div>
                </div>
                
                <!-- Account Information -->
                <div class="profile-card">
                    <h2>Account Information</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Account Created</span>
                            <span class="info-value" id="accountCreated">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Last Login</span>
                            <span class="info-value" id="lastLogin">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">User ID</span>
                            <span class="info-value" id="userId">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email Verified</span>
                            <span class="info-value" id="emailVerified">No</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Account Status</span>
                            <span class="info-value" id="accountStatus">Active</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="profile-actions">
                <button onclick="openEditModal()" class="action-btn">
                    ‚úèÔ∏è Edit Profile
                </button>
                <button onclick="changeEmoji()" class="action-btn">
                    üîÑ Change Avatar
                </button>
                <button onclick="viewMyListings()" class="action-btn">
                    üìö View My Listings
                </button>
                <button onclick="logoutUser()" class="action-btn logout">
                    üö™ Logout
                </button>
            </div>
            
            <!-- Success/Error Messages -->
            <div id="profileError" class="error-message"></div>
            <div id="profileSuccess" class="success-message"></div>
        </div>
        
        <!-- Edit Profile Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Profile Information</h2>
                    <p>Update your personal details</p>
                </div>
                
                <form id="editProfileForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editFirstName">First Name</label>
                            <input type="text" id="editFirstName" placeholder="Enter first name">
                        </div>
                        <div class="form-group">
                            <label for="editLastName">Last Name</label>
                            <input type="text" id="editLastName" placeholder="Enter last name">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editPhone">Phone Number</label>
                        <input type="tel" id="editPhone" placeholder="+92 300 1234567">
                    </div>
                    
                    <div class="form-group">
                        <label for="editUniversity">University/College</label>
                        <input type="text" id="editUniversity" placeholder="University of Punjab">
                    </div>
                    
                    <div class="form-group">
                        <label for="editStudyProgram">Study Program</label>
                        <input type="text" id="editStudyProgram" placeholder="BS Computer Science">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editCurrentYear">Current Year</label>
                            <select id="editCurrentYear">
                                <option value="">Select Year</option>
                                <option value="1st Year">1st Year</option>
                                <option value="2nd Year">2nd Year</option>
                                <option value="3rd Year">3rd Year</option>
                                <option value="4th Year">4th Year</option>
                                <option value="5th Year">5th Year</option>
                                <option value="Graduate">Graduate</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editLocation">Location/City</label>
                            <input type="text" id="editLocation" placeholder="Lahore, Pakistan">
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" onclick="closeEditModal()" class="btn btn-secondary">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="firebase.js"></script>
    <script src="auth.js"></script>
    
    <script>
        // Global variables
        let currentUser = null;
        let userData = null;
        let authCheckInterval = null;
        
        // Load profile data
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            checkAuthStatus();
            
            // Setup auth state listener
            auth.onAuthStateChanged(handleAuthStateChange);
            
            // Setup periodic auth check (every 30 seconds)
            authCheckInterval = setInterval(checkAuthStatus, 30000);
            
            // Setup edit form submission
            document.getElementById('editProfileForm').addEventListener('submit', handleEditProfile);
            
            // Setup user dropdown toggle
            setupUserDropdown();
        });
        
        // Handle auth state changes
        function handleAuthStateChange(user) {
            if (!user) {
                window.location.href = "login.html";
                return;
            }
            
            currentUser = user;
            loadProfileData(user);
            loadUserActivity(user);
            loadUserStats(user);
        }
        
        // Check auth status
        function checkAuthStatus() {
            const user = auth.currentUser;
            if (!user) {
                window.location.href = "login.html";
                return;
            }
            
            // Refresh user token if needed
            user.getIdToken(true).catch(error => {
                console.error("Token refresh error:", error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/user-disabled') {
                    logoutUser();
                }
            });
        }
        
        // Setup user dropdown
        function setupUserDropdown() {
            const userEmojiBtn = document.getElementById('userEmojiBtn');
            const userDropdown = document.getElementById('userDropdown');
            
            if (userEmojiBtn) {
                userEmojiBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userDropdown.classList.toggle('active');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function() {
                    userDropdown.classList.remove('active');
                });
                
                userDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        }
        
        // Load profile data from Firestore
        async function loadProfileData(user) {
            try {
                showLoading();
                const userDoc = await db.collection("users").doc(user.uid).get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    
                    // Display user info
                    displayUserInfo(user, userData);
                    // Update navigation user info
                    updateNavUserInfo(user, userData);
                } else {
                    // Create user document if it doesn't exist
                    await createUserDocument(user);
                    loadProfileData(user); // Reload
                }
            } catch (error) {
                console.error("Error loading profile:", error);
                showError("Error loading profile data. Please refresh the page.");
            } finally {
                hideLoading();
            }
        }
        
        // Create user document
        async function createUserDocument(user) {
            const emojiNumber = generateEmojiNumber(user.email);
            const emoji = emojiNumber === 0 ? "üë®" : "üë©";
            
            const userData = {
                email: user.email,
                emojiNumber: emojiNumber,
                emoji: emoji,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                firstName: "",
                lastName: "",
                phoneNumber: "",
                university: "",
                studyProgram: "",
                currentYear: "",
                location: "",
                totalBooksListed: 0,
                totalBooksSold: 0,
                totalBooksBought: 0,
                totalExchanges: 0,
                emailVerified: user.emailVerified,
                accountStatus: "active",
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection("users").doc(user.uid).set(userData);
            return userData;
        }
        
        // Display user information
        function displayUserInfo(user, data) {
            // Basic Info
            const fullName = `${data.firstName || ''} ${data.lastName || ''}`.trim();
            const displayName = fullName || user.email.split('@')[0];
            
            document.getElementById('profileName').textContent = displayName;
            document.getElementById('profileEmail').textContent = user.email;
            document.getElementById('userType').textContent = data.studyProgram ? "Student" : "User";
            
            // Format dates
            if (data.memberSince) {
                document.getElementById('memberSince').textContent = 
                    `Member since: ${formatDate(data.memberSince)}`;
            }
            
            // Personal Information
            document.getElementById('fullName').textContent = fullName || "Not set";
            document.getElementById('phoneNumber').textContent = data.phoneNumber || "Not set";
            document.getElementById('university').textContent = data.university || "Not set";
            document.getElementById('studyProgram').textContent = data.studyProgram || "Not set";
            document.getElementById('currentYear').textContent = data.currentYear || "Not set";
            document.getElementById('location').textContent = data.location || "Not set";
            
            // Account Information
            document.getElementById('accountCreated').textContent = 
                data.createdAt ? formatDate(data.createdAt) : "Unknown";
            document.getElementById('lastLogin').textContent = 
                data.lastLogin ? formatDate(data.lastLogin) : "Unknown";
            document.getElementById('userId').textContent = user.uid.substring(0, 8) + "...";
            document.getElementById('emailVerified').textContent = 
                user.emailVerified ? "Yes" : "No";
            document.getElementById('accountStatus').textContent = data.accountStatus || "Active";
            
            // Emoji Info
            const emoji = data.emoji || (data.emojiNumber === 0 ? 'üë®' : 'üë©');
            document.getElementById('profileEmoji').textContent = emoji;
            document.getElementById('currentEmojiDisplay').textContent = emoji;
            document.getElementById('emojiText').textContent = emoji;
            document.getElementById('emojiNumber').textContent = data.emojiNumber || 0;
            
            // Rating
            const rating = calculateRating(data);
            document.getElementById('userRating').textContent = `Rating: ${rating}/5`;
            
            // Populate edit form
            populateEditForm(data);
        }
        
        // Update user emoji in navigation
        function updateNavUserInfo(user, userData) {
            const userEmojiBtn = document.getElementById('userEmojiBtn');
            if (!userEmojiBtn) return;
            
            const emoji = userData?.emoji || (userData?.emojiNumber === 0 ? 'üë®' : 'üë©');
            const fullName = `${userData?.firstName || ''} ${userData?.lastName || ''}`.trim();
            const displayName = fullName || user.email.split('@')[0];
            
            // Update emoji button
            userEmojiBtn.textContent = emoji;
            
            // Update dropdown content
            document.getElementById('dropdownEmoji').textContent = emoji;
            document.getElementById('dropdownName').textContent = displayName;
            document.getElementById('dropdownEmail').textContent = user.email;
        }
        
        // Load user statistics
        async function loadUserStats(user) {
            try {
                // Get books listed
                const booksQuery = await db.collection("books")
                    .where("postedBy", "==", user.uid)
                    .get();
                
                const booksSoldQuery = await db.collection("books")
                    .where("postedBy", "==", user.uid)
                    .where("status", "==", "sold")
                    .get();
                
                const booksBoughtQuery = await db.collection("transactions")
                    .where("buyerId", "==", user.uid)
                    .where("status", "==", "completed")
                    .get();
                
                const exchangesQuery = await db.collection("exchanges")
                    .where("userId", "==", user.uid)
                    .where("status", "==", "completed")
                    .get();
                
                // Update display
                document.getElementById('booksListed').textContent = booksQuery.size;
                document.getElementById('booksSold').textContent = booksSoldQuery.size;
                document.getElementById('booksBought').textContent = booksBoughtQuery.size;
                document.getElementById('exchangesMade').textContent = exchangesQuery.size;
                
                // Update Firestore with counts
                await db.collection("users").doc(user.uid).update({
                    totalBooksListed: booksQuery.size,
                    totalBooksSold: booksSoldQuery.size,
                    totalBooksBought: booksBoughtQuery.size,
                    totalExchanges: exchangesQuery.size,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
            } catch (error) {
                console.error("Error loading stats:", error);
            }
        }
        
        // Load user activity
        async function loadUserActivity(user) {
            try {
                // Get recent activities
                const activities = [];
                
                // Get recent book listings
                const recentListings = await db.collection("books")
                    .where("postedBy", "==", user.uid)
                    .orderBy("postedAt", "desc")
                    .limit(5)
                    .get();
                
                recentListings.forEach(doc => {
                    const data = doc.data();
                    activities.push({
                        type: "book_listed",
                        message: `Listed "${data.bookName}" for sale`,
                        time: data.postedAt
                    });
                });
                
                // Get recent transactions
                const recentTransactions = await db.collection("transactions")
                    .where("buyerId", "==", user.uid)
                    .orderBy("transactionDate", "desc")
                    .limit(5)
                    .get();
                
                recentTransactions.forEach(doc => {
                    const data = doc.data();
                    activities.push({
                        type: "book_bought",
                        message: `Purchased "${data.bookName}"`,
                        time: data.transactionDate
                    });
                });
                
                // Sort activities by time
                activities.sort((a, b) => (b.time?.toDate?.() || 0) - (a.time?.toDate?.() || 0));
                
                // Display activities
                const timeline = document.getElementById('activityTimeline');
                timeline.innerHTML = '';
                
                if (activities.length === 0) {
                    timeline.innerHTML = '<div class="activity-item">No recent activity</div>';
                    return;
                }
                
                activities.forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item';
                    
                    let icon = 'üìò';
                    if (activity.type === 'book_listed') icon = 'üí∞';
                    if (activity.type === 'book_bought') icon = 'üõí';
                    
                    activityItem.innerHTML = `
                        <div class="activity-icon">${icon}</div>
                        <div class="activity-content">
                            <div>${activity.message}</div>
                            <div class="activity-time">${formatTimeAgo(activity.time)}</div>
                        </div>
                    `;
                    
                    timeline.appendChild(activityItem);
                });
                
            } catch (error) {
                console.error("Error loading activity:", error);
            }
        }
        
        // Generate emoji number from email
        function generateEmojiNumber(email) {
            if (!email) return 0;
            let hash = 0;
            for (let i = 0; i < email.length; i++) {
                hash = email.charCodeAt(i) + ((hash << 5) - hash);
            }
            return Math.abs(hash) % 2;
        }
        
        // Calculate user rating
        function calculateRating(data) {
            // Simple rating calculation based on activity
            let rating = 4.0; // Base rating
            
            if (data.totalBooksSold > 0) rating += 0.3;
            if (data.totalBooksBought > 0) rating += 0.2;
            if (data.totalExchanges > 0) rating += 0.2;
            if (data.emailVerified) rating += 0.3;
            
            return Math.min(rating, 5.0).toFixed(1);
        }
        
        // Format date
        function formatDate(date) {
            if (!date) return "Unknown";
            if (date.toDate) {
                return date.toDate().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
            return new Date(date).toLocaleDateString();
        }
        
        // Format time ago
        function formatTimeAgo(date) {
            if (!date) return "Just now";
            
            const now = new Date();
            const then = date.toDate ? date.toDate() : new Date(date);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return "Just now";
            if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            if (diffDays < 30) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            
            return formatDate(date);
        }
        
        // Populate edit form
        function populateEditForm(data) {
            document.getElementById('editFirstName').value = data.firstName || "";
            document.getElementById('editLastName').value = data.lastName || "";
            document.getElementById('editPhone').value = data.phoneNumber || "";
            document.getElementById('editUniversity').value = data.university || "";
            document.getElementById('editStudyProgram').value = data.studyProgram || "";
            document.getElementById('editCurrentYear').value = data.currentYear || "";
            document.getElementById('editLocation').value = data.location || "";
        }
        
        // Open edit modal
        function openEditModal() {
            document.getElementById('editModal').classList.add('active');
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }
        
        // Handle edit profile form submission
        async function handleEditProfile(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showError("You must be logged in to update your profile.");
                return;
            }
            
            try {
                showLoading();
                const updates = {
                    firstName: document.getElementById('editFirstName').value.trim(),
                    lastName: document.getElementById('editLastName').value.trim(),
                    phoneNumber: document.getElementById('editPhone').value.trim(),
                    university: document.getElementById('editUniversity').value.trim(),
                    studyProgram: document.getElementById('editStudyProgram').value.trim(),
                    currentYear: document.getElementById('editCurrentYear').value,
                    location: document.getElementById('editLocation').value.trim(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection("users").doc(currentUser.uid).update(updates);
                
                closeEditModal();
                showSuccess("Profile updated successfully!");
                loadProfileData(currentUser); // Refresh data
                
            } catch (error) {
                console.error("Error updating profile:", error);
                showError("Error updating profile: " + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Change emoji function
        async function changeEmoji() {
            if (!currentUser) return;
            
            if (confirm("Do you want to change your avatar?\n\nThis will randomly assign a new emoji (üë® or üë©) based on your email.")) {
                try {
                    showLoading();
                    const emojiNumber = generateEmojiNumber(currentUser.email + Date.now());
                    const emoji = emojiNumber === 0 ? "üë®" : "üë©";
                    
                    await db.collection("users").doc(currentUser.uid).update({
                        emojiNumber: emojiNumber,
                        emoji: emoji,
                        emojiUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showSuccess(`Avatar changed to: ${emoji}`);
                    loadProfileData(currentUser); // Refresh
                    
                } catch (error) {
                    showError("Error updating avatar: " + error.message);
                } finally {
                    hideLoading();
                }
            }
        }
        
        // View my listings
        function viewMyListings() {
            if (!currentUser) return;
            window.location.href = `mylistings.html?user=${currentUser.uid}`;
        }
        
        // Logout function
        async function logoutUser() {
            try {
                showLoading("Logging out...");
                // Clear auth check interval
                if (authCheckInterval) {
                    clearInterval(authCheckInterval);
                }
                
                await auth.signOut();
                window.location.href = "login.html";
            } catch (error) {
                console.error("Error logging out:", error);
                showError("Error logging out: " + error.message);
                hideLoading();
            }
        }
        
        // Show loading state
        function showLoading(message = "Loading...") {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-overlay';
            loadingDiv.innerHTML = `
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">${message}</div>
                </div>
            `;
            
            // Add CSS for loading overlay
            if (!document.querySelector('#loading-styles')) {
                const style = document.createElement('style');
                style.id = 'loading-styles';
                style.textContent = `
                    .loading-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(255, 255, 255, 0.9);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 9999;
                    }
                    .loading-content {
                        text-align: center;
                    }
                    .loading-spinner {
                        width: 50px;
                        height: 50px;
                        border: 5px solid #f3f3f3;
                        border-top: 5px solid #8a56ff;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 20px;
                    }
                    .loading-text {
                        color: #8a56ff;
                        font-weight: 600;
                    }
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(loadingDiv);
        }
        
        // Hide loading state
        function hideLoading() {
            const loadingOverlay = document.querySelector('.loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.remove();
            }
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('profileError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('profileSuccess');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }
    </script>

    <script>// Header shrink on scroll for mobile
let lastScrollTop = 0;
const header = document.querySelector('header');
const shrinkThreshold = 50; // Pixels to scroll before shrinking

window.addEventListener('scroll', function() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    
    if (window.innerWidth <= 768) { // Mobile only
        if (scrollTop > shrinkThreshold) {
            header.classList.add('shrink');
        } else {
            header.classList.remove('shrink');
        }
        
        // Optional: Hide header on scroll down, show on scroll up
        if (scrollTop > lastScrollTop && scrollTop > 100) {
            // Scrolling down
            header.style.transform = 'translateY(-100%)';
        } else {
            // Scrolling up
            header.style.transform = 'translateY(0)';
        }
        
        lastScrollTop = scrollTop;
    } else {
        // Desktop behavior (keep your existing desktop shrink logic)
        if (scrollTop > shrinkThreshold) {
            header.classList.add('shrink');
        } else {
            header.classList.remove('shrink');
        }
    }
});

// Optional: Add parallax-like effect for mobile
window.addEventListener('scroll', function() {
    if (window.innerWidth <= 768) {
        const scrolled = window.pageYOffset;
        const rate = scrolled * -0.3; // Adjust this value for intensity
        
        // Add subtle background color change on scroll
        if (header && scrolled > 20) {
            const opacity = Math.min(scrolled / 200, 0.95);
            header.style.backgroundColor = `rgba(255, 255, 255, ${opacity})`;
            header.style.backdropFilter = 'blur(10px)';
        } else if (header) {
            header.style.backgroundColor = 'white';
            header.style.backdropFilter = 'none';
        }
    }
});</script>
</body>
</html>